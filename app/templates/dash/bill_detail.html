<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Invoice {{ bill.bill_no }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #f4f4f4;
            color: #333;
        }

        @page {
            size: A4 portrait;
            margin: 20mm;
        }

        /* body { font-family: "Times New Roman", serif; font-size: 13px; } */
        .header,
        .footer {
            text-align: center;
        }

        .invoice-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            border: 1px solid black;
            padding: 6px;
            font-size: 12px;
        }

        .table th {
            background: #f0f0f0;
        }

        .right {
            text-align: right;
        }

        .invoice-box {
            background: #fff;
            padding: 40px 50px;
            max-width: 800px;
            margin: 40px auto;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }

        /* -------- Header -------- */
        .invoice-header {
            border-bottom: 3px solid #ffcc66;
            padding-bottom: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .company-info h2 {
            margin: 0;
            font-weight: 600;
        }

        .company-info p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        .brand-logo img {
            max-height: 70px;
            width: auto;
        }

        /* -------- Bill Details -------- */
        .bill-info p {
            margin: 2px 0;
            font-size: 14px;
        }

        .bill-info b {
            color: #000;
        }

        /* -------- Table -------- */
        table.invoice-table th {
            background: #fffcf2;
            color: #171616;
            border-top: none;
            text-transform: uppercase;
            font-size: 13px;
        }

        table.invoice-table td {
            vertical-align: middle;
            font-size: 14px;
            border-color: #000;
        }

        .right {
            text-align: right;
        }

        /* -------- Totals -------- */
        .totals-table td {
            font-size: 14px;
            border: none;
        }

        .totals-table tr:last-child td {
            font-weight: 600;
            font-size: 16px;
            border-top: 2px solid #ffcc66;
        }

        /* -------- Footer -------- */
        .invoice-footer {
            margin-top: 40px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }

        .sign-box {
            text-align: right;
            margin-top: 50px;
        }

        /* -------- Buttons -------- */
        .btn-actions {
            text-align: center;
            margin-top: 30px;
        }

        @media print {
            body {
                background: white;
            }

            .btn-actions {
                display: none !important;
            }

            .invoice-box {
                box-shadow: none;
                border: none;
                margin: 0;
            }
        }

        .banking-details,
        .payment-details {
            width: 48%;
            border: 1px solid #000;
            padding: 15px;
        }

        .bank-totals {
            gap: 30px;
            align-items: flex-start;
        }

        .banking-details {
            flex: 1;
            border: 1px solid #ddd;
            padding: 15px 20px;
            /* background: #fffcf2; */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .banking-details .qr-img {
            width: 100px;
            height: 100px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .totals-box {
            flex: 1;
            border: 1px solid #ddd;
            padding: 15px 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .bank-totals {
            gap: 30px;
            align-items: flex-start;
        }

        .banking-details,
        .totals-box {
            flex: 1;
            border: 1px solid #ddd;
            padding: 15px 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            /* background: #fffcf2; */
        }

        .box-title {
            position: absolute;
            top: -14px;
            left: 15px;
            background: #fcdf7f;

            padding: 2px 10px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 4px;
            color: #000000;
        }

        .bank-content {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .bank-content .qr-img {
            width: 70px;
            height: 70px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .bank-info p {
            margin: 2px 0;
            font-size: 13px;
        }

        .invoice-header {
            border-bottom: 3px solid #ffcc66;
            padding-bottom: 15px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Align all content to left */
        }

        .brand-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            /* space between logo and text */
        }

        .brand-logo img {
            max-height: 90px;
            /* increased size */
            width: auto;
        }
    </style>
</head>

<body>

    <div class="invoice-box">
        <!-- Header -->
        <div class="invoice-header">
            <div class="brand-wrapper">
                <div class="brand-logo">
                    <img src="/static/images/Bill_logo.png" alt="Company Logo">
                </div>
                <div class="company-info">
                    <h3>NEW MAHAVIR TENT <span style="font-size: 25px;">& </span>EVENT MANAGEMENT</h3>
                    <p>Girija Colony, Near Ganpati Temple, Bhusawal Road, Jamner.<br>
                        Shop No.11/89, Old BJ Market, Near   Balgandharv, Jalgaon.<br>
                        Mo.: 9595109029, 9922221290</p>
                </div>
            </div>
        </div>


        <!-- Bill Details -->
        <div class="row mb-4 bill-info">
            <div class="col-6">
                <p><b>Customer : {{ bill.customer_name }}</b></p>
                <p><b>Mobile :</b> {{ bill.mobile_no }}</p>
                <p><b>Address :</b> {{ bill.address }}</p>
            </div>
            <div class="col-6 text-end">

                <p><b>Invoice No:</b> {{ bill.bill_no }}</p>
                <p><b>Event Date:</b> {{ bill.event_date|date:"d/m/Y" }}</p>
            </div>
        </div>

        <!-- Items Table -->
        <table class="table table-bordered invoice-table">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Particulars</th>
                    <th class="right">Qty</th>
                    <th class="right">Rate (‚Çπ)</th>
                    <th class="right">Amount (‚Çπ)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in bill.items.all %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.product.name }}</td>
                    <td class="right">{{ item.quantity }}</td>
                    <td class="right">{{ item.rate }}</td>
                    <td class="right">{{ item.amount }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>


        <!-- Banking + Totals Section -->
        <div class="bank-totals d-flex justify-content-between mt-4">

            <!-- Banking Details -->
            <div class="banking-details rounded">
                <div class="box-title">Banking Details</div>
                <div class="bank-content">
                    <img src="/static/images/QR.png" alt="QR Code" class="qr-img">
                    <div class="bank-info">
                        <p><strong>New Mahavir Tent House</strong></p>
                        <p><strong>A/C:</strong> 50200074321550</p>
                        <p><strong>IFSC:</strong> HDFC0003385</p>
                        <p><strong>Branch:</strong> HDFC Bank, Jamner</p>
                    </div>
                </div>
            </div>

            <!-- Totals -->
            <div class="totals-box rounded">
                <div class="box-title">Totals</div>
                <table class="table totals-table mb-0">
                    <tr>
                        <td class="right"><b>Total:</b></td>
                        <td class="right">{{ bill.total_amount }}</td>
                       
                    </tr>
                    <tr>
                        <td class="right"><b>Advance:</b></td>
                        <td class="right">{{ bill.advance }}</td>
                    </tr>
                    <tr>
                        <td class="right"><b>Discount:</b></td>
                        <td class="right"><b>{{ bill.discount }}</b></td>
                    </tr>
                    <tr>
                        <td class="right"><b>Due:</b></td>
                        <td class="right"><b>{{ bill.due }}</b></td>
                    </tr>
                    <tr>
                        <td class="right"><b>Grand Total:</b></td>
                        <td class="right"><b>‚Çπ {{ bill.total_amount }}</b></td>
                    </tr>
                </table>
            </div>

        </div>



        <!-- Signature -->
        <div class="sign-box">
            <p><b>Authorized Signatory</b></p>
        </div>

        <!-- Footer -->
        <!-- <div class="invoice-footer">
            Thank you for your business!
        </div> -->
    </div>

    <!-- Action Buttons -->
  <div class="text-center" style="margin-top:20px;">
  <button onclick="window.print()" class="btn-print">üñ®Ô∏è Print</button>
  <a href="{% url 'download_bill_pdf' bill.id %}" class="btn btn-success">‚¨áÔ∏è Download PDF</a>
  <a href="{% url 'delete_bill' bill.id %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this bill?')">üóëÔ∏è Delete Bill</a>
  <a href="{% url 'bill_list' %}" class="btn btn-secondary">‚Üê Back</a>
  <a href="{% url 'send_reminder' bill.id %}" class="btn btn-sm btn-success"><i class="fa fa-whatsapp"></i> Reminder</a>

  </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        async function sharePDF() {
            const element = document.querySelector('.invoice-box');

            // Generate PDF as base64
            const opt = {
                margin: 0.5,
                filename: 'Invoice_{{ bill.bill_no }}.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            const worker = html2pdf().from(element).set(opt);
            const pdfBlob = await worker.outputPdf('blob');

            // Convert blob to base64
            const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(pdfBlob);
            });

            // Upload to Django
            const formData = new FormData();
            formData.append('pdf', base64);

            const response = await fetch("{% url 'upload_invoice_pdf' bill.id %}", {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                body: formData
            });

            const data = await response.json();
            if (data.file_url) {
                const whatsappUrl = `https://wa.me/?text=Here is your invoice: ${data.file_url}`;
                window.open(whatsappUrl, '_blank');
            } else {
                alert("Upload failed. Please try again.");
            }
        }
    </script>


</body>

</html>