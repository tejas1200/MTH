{% extends 'dash/base.html' %}
{% block title %}Create Bill{% endblock %}



{% block content %}
<main class="main-content">
  <div class="header">
    <h3 class="fw-bold mb-4 text-white">ðŸ§¾ Create New Bill</h3>
  </div>

  <form method="post" id="billForm">{% csrf_token %}
    <div class="form-card mb-3">
      <h6 style="color: orangered; text-align: end; margin-bottom: -20px;" >{{ next_bill_no }}</h6>
      <h4>Customer Details</h4>
      <div class="row g-3">
       
        <div class="col-md-3">
          <label>Customer</label>
          <input name="customer_name" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label>Contact</label>
          <input name="contact_number" class="form-control">
        </div>
        <div class="col-md-3">
          <label>Event Date</label>
          <input type="date" name="event_date" class="form-control">
        </div>
        <div class="col-md-3">
          <label>Bill Date</label>
          <input type="date" name="bill_date" class="form-control" value="{{ today|default:None }}">
        </div>
        <div class="col-md-12">
          <label>Address</label>
          <input name="address" class="form-control">
        </div>
      </div>
    </div>

    <div class="table-card mb-3">
      <h4>Items</h4>
      <div class="table-responsive">
        <table class="table" id="billingTable">
          <thead>
            <tr>
              <th>No.</th>
              <th>Particular's</th>
              <th>Qty</th>
              <th>Days</th>
              <th>Rate</th>
              <th>Amount</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="row-no">1</td>
              <td>
                  <div class="autocomplete-box">
                      <input type="text" class="form-control product-search" placeholder="Search product...">

                      <input type="hidden" name="product[]" class="product-id">
                  </div>
              </td>
              <td><input name="quantity[]" type="number" min="0" value="1" class="form-control qty"></td>
              <td><input name="days[]" type="number" min="1" value="1" class="form-control days"></td>
              <td><input name="rate[]" type="number" step="0.01" class="form-control rate" readonly></td>
              <td><input name="amount[]" class="form-control amount" readonly></td>
              <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-row">âœ•</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="text-end">
        <button id="addRow" type="button" class="btn btn-sm btn-primary">Add Row</button>
      </div>
    </div>

    <div class="form-card">
      <h4>Payment</h4>
      <div class="row g-3">
        <div class="col-md-3"><label>Subtotal</label><input id="subtotal" class="form-control" readonly></div>
        <div class="col-md-3"><label>Discount</label><input name="discount" id="discount" type="number" value="0" class="form-control"></div>
        <div class="col-md-3"><label>Additional Charges</label><input name="additional_charges" id="additional_charges" type="number" value="0" class="form-control"></div>
        <div class="col-md-3"><label>Grand Total</label><input id="grand_total" class="form-control" readonly></div>
        <div class="col-md-3"><label>Advance</label><input name="advance" id="advance" type="number" value="0" class="form-control"></div>
        <div class="col-md-3"><label>Pending/Due</label><input id="pending" class="form-control" readonly></div>
        <div class="col-md-6"><label>Total (in words)</label><input id="total_words" class="form-control" readonly></div>
        <div class="col-md-4 mb-3">
          <label for="payment_method" class="form-label">Payment Method</label>
          <select name="payment_method" id="payment_method" class="form-select">
            <option value="Cash">ðŸ’µ Cash</option>
            <option value="UPI">ðŸ“± UPI</option>
            <option value="Card">ðŸ’³ Card</option>
          </select>
        </div>
      </div>
    </div>

    <div class="text-center mt-3">
      <button type="submit" class="btn btn-success">Save Bill</button>
      <a href="{% url 'bill_list' %}" class="btn btn-secondary">Back to list</a>
    </div>
  </form>
</main>

<div id="suggestion-portal" class="suggestion-portal"></div>

<script>

/* ----------------------------------
   Utility Functions 
---------------------------------- */

function updateRowNumbers() {
    document.querySelectorAll('#billingTable tbody tr')
        .forEach((r, i) => r.querySelector('.row-no').textContent = i + 1);
}

function toFloat(v) { return parseFloat(v || 0) || 0; }

function recalcAll() {
    let subtotal = 0;

    document.querySelectorAll('#billingTable tbody tr').forEach(row => {
        const qty = toFloat(row.querySelector('.qty').value);
        const days = toFloat(row.querySelector('.days').value);
        const rate = toFloat(row.querySelector('.rate').value);

        const amount = qty * days * rate;
        row.querySelector('.amount').value = amount.toFixed(2);

        subtotal += amount;
    });

    document.getElementById('subtotal').value = subtotal.toFixed(2);

    const discount = toFloat(document.getElementById('discount').value);
    const add = toFloat(document.getElementById('additional_charges').value);
    const grand = subtotal - discount + add;

    document.getElementById('grand_total').value = grand.toFixed(2);

    const advance = toFloat(document.getElementById('advance').value);
    const pending = grand - advance;

    document.getElementById('pending').value = pending.toFixed(2);

    document.getElementById('total_words').value =
        numberToWords(Math.floor(grand)) + " Rupees only";
}

function numberToWords(n) {
    const under20 = ["zero","one","two","three","four","five","six","seven","eight","nine","ten",
    "eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];

    const tens = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];

    if (n < 20) return under20[n];
    if (n < 100) return tens[Math.floor(n/10)] + (n%10 ? " " + under20[n%10] : "");
    if (n < 1000) return under20[Math.floor(n/100)] + " hundred" + (n%100 ? " " + numberToWords(n%100) : "");
    if (n < 100000) return numberToWords(Math.floor(n/1000)) + " thousand " + numberToWords(n%1000);
    if (n < 10000000) return numberToWords(Math.floor(n/100000)) + " lakh " + numberToWords(n%100000);
    return numberToWords(Math.floor(n/10000000)) + " crore " + numberToWords(n%10000000);
}

/* ----------------------------------
   AUTOCOMPLETE PORTAL
---------------------------------- */

// Build product list from Django
const PRODUCTS = [
    {% for p in products %}
        { id: "{{ p.id }}", name: "{{ p.name }}", rate: "{{ p.rate }}" },
    {% endfor %}
];

const portal = document.getElementById("suggestion-portal");

// Autocomplete search
document.addEventListener("input", function (e) {
    if (!e.target.classList.contains("product-search")) return;

    const input = e.target;
    const row = input.closest("tr");
    const text = input.value.toLowerCase();

    const matches = PRODUCTS.filter(p => p.name.toLowerCase().includes(text));

    if (matches.length === 0) {
        portal.style.display = "none";
        return;
    }

    // Build suggestions
    portal.innerHTML = matches.map(p => `
        <div class="list-group-item" 
             data-id="${p.id}" 
             data-rate="${p.rate}">
            ${p.name}
        </div>
    `).join("");

    // Position dropdown
    const rect = input.getBoundingClientRect();
    portal.style.top = rect.bottom + window.scrollY + "px";
    portal.style.left = rect.left + window.scrollX + "px";
    portal.style.width = rect.width + "px";
    portal.style.display = "block";

    // Handle click selection
    portal.querySelectorAll(".list-group-item").forEach(item => {
        item.onclick = function () {
            input.value = this.textContent.trim();
            row.querySelector(".product-id").value = this.dataset.id;

            // Fill rate
            row.querySelector(".rate").value =
                parseFloat(this.dataset.rate).toFixed(2);

            portal.style.display = "none";
            recalcAll();
        };
    });
});

// Hide portal when clicking outside
document.addEventListener("click", function (e) {
    if (!e.target.classList.contains("product-search")) {
        portal.style.display = "none";
    }
});

/* ----------------------------------
   ADD / REMOVE ROWS
---------------------------------- */

document.getElementById("addRow").addEventListener("click", function () {
    const tbody = document.querySelector("#billingTable tbody");
    const row = tbody.rows[0].cloneNode(true);

    row.querySelector(".product-search").value = "";
    row.querySelector(".product-id").value = "";
    row.querySelector(".rate").value = "";
    row.querySelector(".amount").value = "";
    row.querySelector(".qty").value = 1;
    row.querySelector(".days").value = 1;

    tbody.appendChild(row);
    updateRowNumbers();
    recalcAll();
});

// Remove row
document.addEventListener("click", function (e) {
    if (!e.target.classList.contains("remove-row")) return;
    const tbody = document.querySelector("#billingTable tbody");

    if (tbody.rows.length <= 1) {
        alert("At least one row required");
        return;
    }

    e.target.closest("tr").remove();
    updateRowNumbers();
    recalcAll();
});

/* ----------------------------------
   LIVE RECALC
---------------------------------- */

document.addEventListener("input", function (e) {
    if (e.target.matches(".qty, .days, #discount, #advance, #additional_charges")) {
        recalcAll();
    }
});

/* ----------------------------------
   INIT
---------------------------------- */

document.addEventListener("DOMContentLoaded", function () {
    updateRowNumbers();
    recalcAll();
});

</script>



{% endblock %}
